#! /bin/bash
if [ -z "$ACMACSD_ROOT" ]; then
    echo ACMACSD_ROOT not set >&2
    exit 1
fi

failed()
{
    echo "FAILED" >&2
    exit 1
}

trap failed ERR

NPROC=$(if [ "$(uname -s)" = "Darwin" ]; then /usr/sbin/sysctl -n hw.logicalcpu; else /usr/bin/nproc; fi)

# https://mongodb.github.io/mongo-cxx-driver/mongocxx-v3/installation/

export PKG_CONFIG_PATH="$ACMACSD_ROOT"/lib/pkgconfig

SRC_DIR="$ACMACSD_ROOT/sources"
MONGO_CXX_SRC="$SRC_DIR/mongo-cxx-driver"
if [ -d "$MONGO_CXX_SRC" ]; then
    cd "$MONGO_CXX_SRC"
    git pull
else
    git clone https://github.com/mongodb/mongo-cxx-driver.git --branch releases/stable --depth 1 "$MONGO_CXX_SRC"
fi
cd "$MONGO_CXX_SRC"/build
cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$ACMACSD_ROOT" ..
# -DBSONCXX_POLY_USE_BOOST=1
# Only for MNMLSTC polyfill (default on Linux and macos
# make EP_mnmlstc_core
make -j$NPROC
make install
if [ "$(uname)" == "Darwin" ]; then
    cd "$ACMACSD_ROOT/lib"
    rm -f *.a
    for library in libbsoncxx._noabi.dylib libmongocxx._noabi.dylib; do
        /usr/bin/install_name_tool -id "$ACMACSD_ROOT/lib/$library" "$library"
    done
    /usr/bin/install_name_tool -change "@rpath/libbsoncxx._noabi.dylib" "$ACMACSD_ROOT/lib/libbsoncxx._noabi.dylib" "libmongocxx._noabi.dylib"
fi
