#! /bin/bash
if [ -z "$ACMACSD_ROOT" ]; then
    echo ACMACSD_ROOT not set >&2
    exit 1
fi

failed()
{
    echo "FAILED" >&2
    exit 1
}

trap failed ERR

SRC_DIR="$ACMACSD_ROOT/sources"
PACKAGE_DIR="$SRC_DIR/boost"
SUBMODULES=(assert concept_check config core detail function_types functional fusion integer iterator math move mpl optional predef preprocessor range regex smart_ptr spirit static_assert throw_exception type_index type_traits typeof tti utility variant)
INCLUDE="$ACMACSD_ROOT/include/boost"

if [ -d "$PACKAGE_DIR" ]; then
    cd "$PACKAGE_DIR"
    git pull
else
    git clone https://github.com/boostorg/boost.git "$PACKAGE_DIR"
fi
cd "$PACKAGE_DIR"
for sub in "${SUBMODULES[@]}"; do
    git submodule update --init "libs/$sub"
done
if [ ! -d "$INCLUDE" ]; then
    mkdir "$INCLUDE"
fi
cd "$INCLUDE"
for sub in "${SUBMODULES[@]}"; do
    # "cp -as" can be used instead of the below but it is not available on macOS
    srcdir="$SRC_DIR/boost/libs/$sub/include/boost"
    for dirname in $(cd "$srcdir"; find . -type d -not -name .); do
        if [ ! -d "$dirname" ]; then
            mkdir "$dirname"
        fi
    done
    for filename in $(cd "$srcdir"; find . -type f | cut -c 3-); do
        ln -sf "$srcdir/$filename" "$filename"
    done
done
