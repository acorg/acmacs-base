#! /bin/bash
if [ -z "$ACMACSD_ROOT" ]; then
    echo ACMACSD_ROOT not set >&2
    exit 1
fi
if [ $# -ne 1 ]; then
    echo "Usage: $0 <package-name>" >&2
    exit 2
fi

failed()
{
    echo "FAILED" >&2
    exit 1
}

trap failed ERR

NPROC=$(if [ "$(uname -s)" = "Darwin" ]; then /usr/sbin/sysctl -n hw.logicalcpu; else /usr/bin/nproc; fi)

SRC_DIR=$ACMACSD_ROOT/sources

PACKAGE="$1"

echo "======================================================================"
echo Updating $PACKAGE
if [ -d $SRC_DIR/$PACKAGE ]; then
    cd $SRC_DIR/$PACKAGE
    git pull
else
    git clone git@github.com:acorg/$PACKAGE.git $SRC_DIR/$PACKAGE
fi
make -C $SRC_DIR/$PACKAGE -j$NPROC install
echo "======================================================================"
